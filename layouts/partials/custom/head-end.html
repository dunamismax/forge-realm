<!-- Custom performance optimizations -->
<meta name="format-detection" content="telephone=no">
<meta name="theme-color" content="#50fa7b">
<meta name="msapplication-navbutton-color" content="#50fa7b">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-capable" content="yes">

<!-- Preload critical assets -->
<link rel="preload" href="/images/ideal-magic-PNG-circular-emblem.webp" as="image" type="image/webp">
<link rel="preload" href="/favicon.ico" as="image" type="image/x-icon">

<!-- DNS prefetch for external resources -->
<link rel="dns-prefetch" href="//fonts.googleapis.com">
<link rel="dns-prefetch" href="//cdnjs.cloudflare.com">
<link rel="dns-prefetch" href="//discord.gg">
<link rel="dns-prefetch" href="//github.com">

<!-- Preconnect for critical external resources -->
<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
<link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>

<!-- Resource hints for performance -->
<link rel="prefetch" href="/docs/">
<link rel="prefetch" href="/docs/gameplay/">
<link rel="prefetch" href="/docs/cards/">

<!-- Enhanced Ideal Magic Performance & UX System -->
{{ $enhancedJS := resources.Get "js/ideal-magic-enhanced.js" | minify }}
<script src="{{ $enhancedJS.RelPermalink }}"></script>

<!-- Service Worker Registration -->
<script>
  if ('serviceWorker' in navigator && (window.location.protocol === 'https:' || window.location.hostname === 'localhost')) {
    navigator.serviceWorker.register('/sw.js')
      .then((registration) => {
        console.log('Service Worker registered:', registration.scope);
        
        // Update service worker when new version available
        registration.addEventListener('updatefound', () => {
          const newWorker = registration.installing;
          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              // Show update notification
              showUpdateNotification();
            }
          });
        });
      })
      .catch((error) => {
        console.warn('Service Worker registration failed:', error);
      });
  }
  
  function showUpdateNotification() {
    const notification = document.createElement('div');
    notification.style.cssText = `
      position: fixed;
      top: 1rem;
      right: 1rem;
      background: var(--accent-primary, #3E2977);
      color: white;
      padding: 1rem;
      border-radius: 0.5rem;
      z-index: 10000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      font-size: 0.875rem;
      max-width: 300px;
    `;
    notification.innerHTML = `
      <div>New version available!</div>
      <button onclick="location.reload()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.25rem 0.5rem; border-radius: 0.25rem; margin-top: 0.5rem; cursor: pointer;">Update</button>
      <button onclick="this.parentElement.remove()" style="background: none; border: none; color: white; float: right; cursor: pointer; font-size: 1.2rem; line-height: 1;">Ã—</button>
    `;
    document.body.appendChild(notification);
    
    // Auto-hide after 10 seconds
    setTimeout(() => notification.remove(), 10000);
  }
</script>

<!-- PWA Manifest -->
<link rel="manifest" href="/site.webmanifest">

<!-- Advanced Performance Monitoring -->
<script>
  // Web Vitals monitoring
  if ('PerformanceObserver' in window) {
    // Largest Contentful Paint
    new PerformanceObserver((list) => {
      for (const entry of list.getEntries()) {
        if (entry.startTime < 2500) {
          console.log('LCP (Good):', entry.startTime);
        } else if (entry.startTime < 4000) {
          console.log('LCP (Needs Improvement):', entry.startTime);
        } else {
          console.log('LCP (Poor):', entry.startTime);
        }
      }
    }).observe({entryTypes: ['largest-contentful-paint']});
    
    // First Input Delay
    new PerformanceObserver((list) => {
      for (const entry of list.getEntries()) {
        const fid = entry.processingStart - entry.startTime;
        if (fid < 100) {
          console.log('FID (Good):', fid);
        } else if (fid < 300) {
          console.log('FID (Needs Improvement):', fid);
        } else {
          console.log('FID (Poor):', fid);
        }
      }
    }).observe({entryTypes: ['first-input']});
    
    // Cumulative Layout Shift
    let clsValue = 0;
    new PerformanceObserver((list) => {
      for (const entry of list.getEntries()) {
        if (!entry.hadRecentInput) {
          clsValue += entry.value;
        }
      }
      
      if (clsValue < 0.1) {
        console.log('CLS (Good):', clsValue);
      } else if (clsValue < 0.25) {
        console.log('CLS (Needs Improvement):', clsValue);
      } else {
        console.log('CLS (Poor):', clsValue);
      }
    }).observe({entryTypes: ['layout-shift']});
  }
</script>

<!-- Critical CSS for Performance -->
<style>
  /* Critical above-the-fold styles */
  .nav-container,
  nav.hextra-max-navbar-width {
    height: var(--nav-height-mobile, 3.5rem);
    min-height: var(--nav-height-mobile, 3.5rem);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  }
  
  /* Apply navigation classes immediately */
  nav.hextra-max-navbar-width {
    display: flex;
    align-items: center;
    padding: 0 0.75rem;
    gap: 0.25rem;
  }
  
  nav .hx\:flex.hx\:items-center.hx\:hover\:opacity-75 {
    display: flex !important;
    align-items: center !important;
    margin-right: auto !important;
    transition: opacity 0.15s ease;
    flex-shrink: 0;
    min-width: 0;
  }
  
  nav .hx\:flex.hx\:items-center.hx\:hover\:opacity-75:hover {
    opacity: 0.8;
  }
  
  nav .hx\:flex.hx\:items-center.hx\:hover\:opacity-75 img {
    width: 2rem !important;
    height: 2rem !important;
    margin-right: 0.375rem !important;
    border-radius: 0.375rem;
    flex-shrink: 0;
  }
  
  nav .hx\:flex.hx\:items-center.hx\:hover\:opacity-75 span {
    font-size: 0.9rem !important;
    font-weight: 700 !important;
    white-space: nowrap;
    color: var(--text-primary);
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  /* Mobile action buttons container */
  nav .hx\:gap-2 {
    gap: 0.125rem !important;
  }
  
  nav a.hx\:p-2.hx\:text-current {
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    min-width: 2.25rem !important;
    min-height: 2.25rem !important;
    padding: 0.375rem !important;
    border-radius: 0.375rem;
    transition: all 0.15s ease;
    color: var(--text-secondary);
    flex-shrink: 0;
  }
  
  nav a.hx\:p-2.hx\:text-current:hover {
    background-color: var(--bg-secondary);
    color: var(--text-primary);
    transform: translateY(-1px);
  }
  
  /* Hamburger menu button */
  .hamburger-menu {
    min-width: 2.25rem !important;
    min-height: 2.25rem !important;
    padding: 0.375rem !important;
    margin-right: -0.375rem !important;
    flex-shrink: 0;
  }
  
  /* Hide non-essential elements on mobile */
  @media (max-width: 1023px) {
    nav [title*="Search"],
    nav a[href*="search"],
    nav .search-input,
    nav input[type="search"],
    nav a.hx\:text-sm:not([class*="hx:p-2"]) {
      display: none !important;
    }
  }
  
  @media (min-width: 480px) {
    .nav-container,
    nav.hextra-max-navbar-width {
      height: var(--nav-height-tablet, 4rem);
      min-height: var(--nav-height-tablet, 4rem);
      padding: 0 1rem;
      gap: 0.5rem;
    }
    
    nav .hx\:flex.hx\:items-center.hx\:hover\:opacity-75 img {
      width: 2.5rem !important;
      height: 2.5rem !important;
      margin-right: 0.5rem !important;
    }
    
    nav .hx\:flex.hx\:items-center.hx\:hover\:opacity-75 span {
      font-size: 1rem !important;
    }
    
    nav a.hx\:p-2.hx\:text-current {
      min-width: 2.5rem !important;
      min-height: 2.5rem !important;
      padding: 0.5rem !important;
    }
    
    .hamburger-menu {
      min-width: 2.5rem !important;
      min-height: 2.5rem !important;
      padding: 0.5rem !important;
    }
  }
  
  @media (min-width: 1024px) {
    .nav-container,
    nav.hextra-max-navbar-width {
      height: var(--nav-height-desktop, 5rem);
      min-height: var(--nav-height-desktop, 5rem);
      padding: 0 2rem;
      gap: 1rem;
    }
    
    nav .hx\:flex.hx\:items-center.hx\:hover\:opacity-75 img {
      width: 3.5rem !important;
      height: 3.5rem !important;
      margin-right: 0.75rem !important;
    }
    
    nav .hx\:flex.hx\:items-center.hx\:hover\:opacity-75 span {
      font-size: 1.25rem !important;
    }
    
    nav a.hx\:p-2.hx\:text-current {
      min-width: 3rem !important;
      min-height: 3rem !important;
      padding: 0.75rem !important;
    }
  }
  
  /* Performance optimizations */
  .hero-section {
    contain: layout style paint;
    padding: 2rem 1rem;
    text-align: center;
  }
  
  /* Anti-flash styling */
  html, body {
    background-color: var(--bg-primary, #ffffff);
  }
  
  .dark html, .dark body {
    background-color: var(--bg-primary, #111827);
  }
</style>